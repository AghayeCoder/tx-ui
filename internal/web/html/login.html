<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>{{ .host }}-{{ i18n .title}}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        (function () {
            try {
                var saved = localStorage.getItem('panelThemeMode');
                var mode = (saved === 'light' || saved === 'dark' || saved === 'system') ? saved : 'system';
                var prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                var dark = mode === 'dark' || (mode === 'system' && prefersDark);
                if (dark) {
                    document.documentElement.classList.add('dark');
                }
            } catch (_) {
                // Ignore storage/media errors.
            }

            try {
                var html = document.documentElement;
                var match = document.cookie.match(/(?:^|;\s*)lang=([^;]+)/);
                var cookieLang = match ? decodeURIComponent(match[1]) : '';
                if (cookieLang) {
                    html.setAttribute('lang', cookieLang);
                }
                var explicitLang = (html.getAttribute('lang') || '').replace(/_/g, '-').toLowerCase();
                var browserLang = ((navigator.language || navigator.userLanguage || '') + '').replace(/_/g, '-').toLowerCase();
                var lang = explicitLang || browserLang;
                var rtl = /^(fa|ar|he|ur)\b/.test(lang);
                if (rtl) {
                    html.setAttribute('dir', 'rtl');
                    html.classList.add('rtl');
                } else {
                    html.setAttribute('dir', 'ltr');
                    html.classList.remove('rtl');
                }
            } catch (_) {
                // Ignore language detection errors.
            }
        })();
    </script>
    <style>
        :root {
            color-scheme: light;
            --bg: hsl(210 33% 98%);
            --card: hsl(0 0% 100%);
            --border: hsl(214.3 31.8% 91.4%);
            --text: hsl(222.2 84% 4.9%);
            --muted: hsl(215.4 16.3% 46.9%);
            --primary: hsl(217.2 91.2% 59.8%);
            --primary-hover: hsl(221.2 83.2% 53.3%);
            --focus: hsla(217.2, 91.2%, 59.8%, 0.25);
            --danger: #b91c1c;
            --input-bg: hsl(0 0% 100%);
            --shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
            --glow-a: hsla(217.2, 91.2%, 59.8%, 0.12);
            --glow-b: hsla(210, 40%, 45%, 0.08);
        }

        :root.dark {
            color-scheme: dark;
            --bg: hsl(222.2 84% 4.9%);
            --card: hsl(222.2 84% 4.9%);
            --border: hsl(217.2 32.6% 17.5%);
            --text: hsl(210 40% 98%);
            --muted: hsl(215 20.2% 65.1%);
            --primary: hsl(217.2 91.2% 59.8%);
            --primary-hover: hsl(221.2 83.2% 63.3%);
            --focus: hsla(217.2, 91.2%, 59.8%, 0.28);
            --danger: #f87171;
            --input-bg: hsl(217.2 32.6% 17.5%);
            --shadow: 0 20px 40px rgba(2, 6, 23, 0.55);
            --glow-a: hsla(217.2, 91.2%, 59.8%, 0.16);
            --glow-b: hsla(224.3, 76.3%, 48%, 0.2);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Vazirmatn', 'Segoe UI', Inter, -apple-system, BlinkMacSystemFont, sans-serif;
            background:
                    radial-gradient(900px 280px at 20% -10%, var(--glow-a), transparent),
                    radial-gradient(700px 240px at 90% 0%, var(--glow-b), transparent),
                    var(--bg);
            color: var(--text);
            display: grid;
            place-items: center;
            padding: 24px;
        }

        .shell {
            width: min(460px, 100%);
            display: grid;
            gap: 10px;
        }

        .card {
            width: 100%;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 18px;
            box-shadow: var(--shadow);
            padding: 26px;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: "";
            position: absolute;
            inset: 0 auto auto 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), #0ea5a3);
        }

        .title {
            margin: 0 0 2px;
            font-size: 30px;
            font-weight: 700;
            letter-spacing: -0.02em;
            animation: title-in .45s ease-out both;
        }

        .subtitle {
            margin: 8px 0 22px;
            font-size: 14px;
            color: var(--muted);
            line-height: 1.5;
            animation: subtitle-in .55s ease-out both;
            animation-delay: .08s;
        }

        .field {
            display: grid;
            gap: 8px;
            margin-bottom: 13px;
        }

        .label {
            font-size: 13px;
            color: var(--muted);
        }

        .input {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            font-size: 14px;
            color: var(--text);
            background: var(--input-bg);
            outline: none;
        }

        .input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--focus);
        }

        .button {
            width: 100%;
            border: 0;
            border-radius: 10px;
            padding: 13px 14px;
            font-size: 14px;
            font-weight: 600;
            background: var(--primary);
            color: #fff;
            cursor: pointer;
            transition: background-color .15s ease, transform .08s ease;
        }

        .button:hover {
            background: var(--primary-hover);
        }

        .button:active {
            transform: translateY(1px);
        }

        .button:disabled {
            opacity: 0.7;
            cursor: wait;
        }

        .error {
            min-height: 20px;
            margin: 0 0 12px;
            font-size: 13px;
            color: var(--danger);
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .topbar-actions {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .brand {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: .08em;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary);
            box-shadow: 0 0 0 4px var(--focus);
        }

        .lang-select {
            border: 1px solid var(--border);
            border-radius: 999px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 12px;
            padding: 6px 10px;
            outline: none;
        }

        .theme-btn {
            border: 1px solid var(--border);
            border-radius: 999px;
            background: var(--input-bg);
            color: var(--text);
            font-size: 12px;
            padding: 6px 10px;
            cursor: pointer;
        }

        .theme-btn:hover {
            background: color-mix(in srgb, var(--input-bg) 85%, var(--primary) 15%);
        }

        .footer-note {
            text-align: center;
            font-size: 12px;
            color: var(--muted);
        }

        :root[dir="rtl"] body {
            font-family: 'Vazirmatn', 'Segoe UI', Inter, -apple-system, BlinkMacSystemFont, sans-serif;
        }

        :root[dir="rtl"] .title,
        :root[dir="rtl"] .subtitle,
        :root[dir="rtl"] .error,
        :root[dir="rtl"] .label {
            text-align: right;
        }

        :root[dir="rtl"] .input {
            text-align: right;
        }

        :root[dir="rtl"] .brand {
            letter-spacing: 0;
        }

        @keyframes title-in {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes subtitle-in {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
<div class="shell">
    <div class="card">
        <div class="topbar">
            <div class="brand"><span class="dot"></span>TX-UI Panel</div>
            <div class="topbar-actions">
                <button class="theme-btn" id="themeToggle" type="button">System</button>
                <select aria-label="Language" class="lang-select" id="languageSelect">
                    <option value="en-US">üá∫üá∏ English</option>
                    <option value="fa-IR">üáÆüá∑ ŸÅÿßÿ±ÿ≥€å</option>
                    <option value="ar-EG">üá™üá¨ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    <option value="es-ES">üá™üá∏ Espa√±ol</option>
                    <option value="id-ID">üáÆüá© Bahasa Indonesia</option>
                    <option value="ja-JP">üáØüáµ Êó•Êú¨Ë™û</option>
                    <option value="pt-BR">üáßüá∑ Portugu√™s (Brasil)</option>
                    <option value="ru-RU">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
                    <option value="tr-TR">üáπüá∑ T√ºrk√ße</option>
                    <option value="uk-UA">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
                    <option value="vi-VN">üáªüá≥ Ti·∫øng Vi·ªát</option>
                    <option value="zh-CN">üá®üá≥ ÁÆÄ‰Ωì‰∏≠Êñá</option>
                    <option value="zh-TW">üáπüáº ÁπÅÈ´î‰∏≠Êñá</option>
                </select>
            </div>
        </div>
        <h1 class="title">{{ i18n "pages.login.title" }}</h1>
        <p class="subtitle">{{ i18n "pages.login.hello" }}</p>
        <p class="error" id="error"></p>

        <form id="login-form">
            <label class="field">
                <span class="label">{{ i18n "username" }}</span>
                <input autocomplete="username" class="input" id="username" name="username" required type="text">
            </label>

            <label class="field">
                <span class="label">{{ i18n "password" }}</span>
                <input autocomplete="current-password" class="input" id="password" name="password" required type="password">
            </label>

            <label class="field" hidden id="secret-field">
                <span class="label">{{ i18n "secretToken" }}</span>
                <input autocomplete="one-time-code" class="input" id="loginSecret" name="loginSecret" type="password">
            </label>

            <button class="button" id="submit" type="submit">{{ i18n "login" }}</button>
        </form>
    </div>
</div>

<script>
    const basePath = '{{ .base_path }}';
    const form = document.getElementById('login-form');
    const submit = document.getElementById('submit');
    const errorEl = document.getElementById('error');
    const secretField = document.getElementById('secret-field');
    const loginSecretInput = document.getElementById('loginSecret');
    const languageSelect = document.getElementById('languageSelect');
    const themeToggle = document.getElementById('themeToggle');

    const setError = (message) => {
        errorEl.textContent = message || '';
    };

    const setLoading = (loading) => {
        submit.disabled = loading;
        submit.textContent = loading ? '{{ i18n "loading" }}' : '{{ i18n "login" }}';
    };

    const apiPost = async (path, body) => {
        const response = await fetch(basePath + path.replace(/^\//, ''), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
            },
            body: new URLSearchParams(body),
            credentials: 'same-origin',
        });
        return response.json();
    };

    const initSecretField = async () => {
        try {
            const data = await apiPost('/getSecretStatus', {});
            const enabled = !!(data && data.obj);
            secretField.hidden = !enabled;
            loginSecretInput.disabled = !enabled;
            if (!enabled) {
                loginSecretInput.value = '';
            }
        } catch (_) {
            secretField.hidden = true;
            loginSecretInput.disabled = true;
            loginSecretInput.value = '';
        }
    };

    const initLanguageSelect = () => {
        try {
            const htmlLang = (document.documentElement.getAttribute('lang') || '').trim();
            const cookieMatch = document.cookie.match(/(?:^|;\s*)lang=([^;]+)/);
            const cookieLang = cookieMatch ? decodeURIComponent(cookieMatch[1]) : '';
            const current = (cookieLang || htmlLang || 'en-US').replace(/_/g, '-');
            languageSelect.value = current;
            if (!languageSelect.value) {
                languageSelect.value = 'en-US';
            }
        } catch (_) {
            languageSelect.value = 'en-US';
        }

        languageSelect.addEventListener('change', () => {
            const value = (languageSelect.value || 'en-US').trim().replace(/_/g, '-');
            const rtl = /^(fa|ar|he|ur)\b/i.test(value);
            document.documentElement.setAttribute('lang', value);
            document.documentElement.setAttribute('dir', rtl ? 'rtl' : 'ltr');
            document.documentElement.classList.toggle('rtl', rtl);
            document.cookie = 'lang=' + encodeURIComponent(value) + '; path=/; max-age=31536000; SameSite=Lax';
            window.location.reload();
        });
    };

    const getResolvedTheme = (mode) => {
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        return mode === 'system' ? (prefersDark ? 'dark' : 'light') : mode;
    };

    const applyThemeMode = (mode) => {
        const resolved = getResolvedTheme(mode);
        document.documentElement.classList.toggle('dark', resolved === 'dark');
        themeToggle.textContent = mode === 'system' ? 'System' : mode === 'dark' ? 'Dark' : 'Light';
        try {
            localStorage.setItem('panelThemeMode', mode);
        } catch (_) {
            // Ignore storage errors.
        }
    };

    const initThemeToggle = () => {
        let mode = 'system';
        try {
            const saved = localStorage.getItem('panelThemeMode');
            if (saved === 'light' || saved === 'dark' || saved === 'system') {
                mode = saved;
            }
        } catch (_) {
            // Ignore storage errors.
        }
        applyThemeMode(mode);
        themeToggle.addEventListener('click', () => {
            mode = mode === 'light' ? 'dark' : mode === 'dark' ? 'system' : 'light';
            applyThemeMode(mode);
        });
        if (window.matchMedia) {
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            const listener = () => {
                if (mode === 'system') {
                    applyThemeMode(mode);
                }
            };
            if (typeof mq.addEventListener === 'function') {
                mq.addEventListener('change', listener);
            } else if (typeof mq.addListener === 'function') {
                mq.addListener(listener);
            }
        }
    };

    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        setError('');
        setLoading(true);

        const payload = {
            username: document.getElementById('username').value.trim(),
            password: document.getElementById('password').value,
            loginSecret: document.getElementById('loginSecret').value,
        };

        try {
            const data = await apiPost('/login', payload);
            if (data && data.success) {
                window.location.href = basePath + 'panel/';
                return;
            }
            setError((data && data.msg) || '{{ i18n "pages.login.toasts.wrongUsernameOrPassword" }}');
        } catch (_) {
            setError('{{ i18n "error" }}');
        } finally {
            setLoading(false);
        }
    });

    initThemeToggle();
    initLanguageSelect();
    initSecretField();
</script>
</body>
</html>
