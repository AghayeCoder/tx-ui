<!DOCTYPE html>
<html lang="en">
{{template "head" .}}
<style>
    @media (min-width: 769px) {
        .ant-layout-content {
            margin: 24px 16px;
        }
    }

    @media (max-width: 768px) {
        .ant-tabs-nav .ant-tabs-tab {
            margin: 0;
            padding: 12px .5rem;
        }
    }

    .ant-tabs-bar {
        margin: 0;
    }

    .ant-list-item {
        display: block;
    }

    .alert-msg {
        color: rgb(194, 117, 18);
        font-weight: normal;
        font-size: 16px;
        padding: .5rem 1rem;
        text-align: center;
        background: rgb(255 145 0 / 15%);
        margin: 1.5rem 2.5rem 0rem;
        border-radius: .5rem;
        transition: all 0.5s;
        animation: signal 3s cubic-bezier(0.18, 0.89, 0.32, 1.28) infinite;
    }

    .alert-msg:hover {
        cursor: default;
        transition-duration: .3s;
        animation: signal 0.9s ease infinite;
    }

    @keyframes signal {
        0% {
            box-shadow: 0 0 0 0 rgba(194, 118, 18, 0.5);
        }

        50% {
            box-shadow: 0 0 0 6px rgba(0, 0, 0, 0);
        }

        100% {
            box-shadow: 0 0 0 6px rgba(0, 0, 0, 0);
        }
    }

    .alert-msg > i {
        color: inherit;
        font-size: 24px;
    }

    .collapse-title {
        color: inherit;
        font-weight: bold;
        font-size: 18px;
        padding: 10px 20px;
        border-bottom: 2px solid;
    }

    .collapse-title > i {
        color: inherit;
        font-size: 24px;
    }

    .ant-collapse-content-box .ant-list-item {
        border-bottom: none !important;
    }
</style>
<body>
<a-layout :class="themeSwitcher.currentTheme" id="app" v-cloak>
    {{ template "commonSider" . }}
    <a-layout id="content-layout">
        <a-layout-content>
            <a-spin :delay="500" :spinning="spinning" tip='{{ i18n "loading"}}'>
                <transition appear name="list">
                    <a-alert closable color="red" message='{{ i18n "secAlertTitle" }}'
                             show-icon
                             style="margin-bottom: 10px;"
                             type="error" v-if="confAlerts.length>0">
                        <template slot="description">
                            <b>{{ i18n "secAlertConf" }}</b>
                            <ul>
                                <li v-for="a in confAlerts">[[ a ]]</li>
                            </ul>
                        </template>
                    </a-alert>
                </transition>
                <a-space direction="vertical">
                    <a-card hoverable style="margin-bottom: .5rem; overflow-x: hidden;">
                        <a-row style="display: flex; flex-wrap: wrap; align-items: center;">
                            <a-col :sm="10" :xs="24" style="padding: 4px;">
                                <a-space direction="horizontal">
                                    <a-button :disabled="saveBtnDisable" @click="updateAllSetting" type="primary">{{
                                        i18n "pages.settings.save" }}
                                    </a-button>
                                    <a-button :disabled="!saveBtnDisable" @click="restartPanel" type="danger">{{ i18n
                                        "pages.settings.restartPanel" }}
                                    </a-button>
                                </a-space>
                            </a-col>
                            <a-col :sm="14" :xs="24">
                                <template>
                                    <div>
                                        <a-back-top :target="() => document.getElementById('content-layout')"
                                                    visibility-height="200"></a-back-top>
                                        <a-alert message='{{ i18n "pages.settings.infoDesc" }}' show-icon
                                                 style="float: right; width: fit-content"
                                                 type="warning">
                                        </a-alert>
                                    </div>
                                </template>
                            </a-col>
                        </a-row>
                    </a-card>
                    <a-tabs default-active-key="1">
                        <a-tab-pane key="1" tab='{{ i18n "pages.settings.panelSettings"}}'>
                            <a-list item-layout="horizontal">
                                <a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.settings.remarkModel"}}'>
                                                <template slot="description">{{ i18n "pages.settings.sampleRemark"}}:
                                                    <i>#[[ remarkSample ]]</i></template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-input-group style="width: 100%;">
                                                <a-select :dropdown-class-name="themeSwitcher.currentTheme"
                                                          mode="multiple"
                                                          style="padding-right: .5rem; min-width: 80%; width: auto;"
                                                          v-model="remarkModel">
                                                    <a-select-option :value="key" v-for="(value, key) in remarkModels">
                                                        [[ value ]]
                                                    </a-select-option>
                                                </a-select>
                                                <a-select :dropdown-class-name="themeSwitcher.currentTheme" style="width: 20%;"
                                                          v-model="remarkSeparator">
                                                    <a-select-option :value="key" v-for="key in remarkSeparators">[[ key
                                                        ]]
                                                    </a-select-option>
                                                </a-select>
                                            </a-input-group>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.panelListeningIPDesc"}}' title='{{ i18n "pages.settings.panelListeningIP"}}'
                                                   type="text"
                                                   v-model="allSetting.webListen"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.panelListeningDomainDesc"}}' title='{{ i18n "pages.settings.panelListeningDomain"}}'
                                                   type="text"
                                                   v-model="allSetting.webDomain"></setting-list-item>
                                <setting-list-item :max="65531" :min="1"
                                                   desc='{{ i18n "pages.settings.panelPortDesc"}}'
                                                   title='{{ i18n "pages.settings.panelPort"}}' type="number"
                                                   v-model="allSetting.webPort"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.publicKeyPathDesc"}}' title='{{ i18n "pages.settings.publicKeyPath"}}'
                                                   type="text"
                                                   v-model="allSetting.webCertFile"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.privateKeyPathDesc"}}' title='{{ i18n "pages.settings.privateKeyPath"}}'
                                                   type="text"
                                                   v-model="allSetting.webKeyFile"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.panelUrlPathDesc"}}' title='{{ i18n "pages.settings.panelUrlPath"}}'
                                                   type="text"
                                                   v-model="allSetting.webBasePath"></setting-list-item>
                                <setting-list-item :min="60" desc='{{ i18n "pages.settings.sessionMaxAgeDesc" }}'
                                                   title='{{ i18n "pages.settings.sessionMaxAge" }}'
                                                   type="number" v-model="allSetting.sessionMaxAge"></setting-list-item>
                                <setting-list-item :min="0" :step="5"
                                                   desc='{{ i18n "pages.settings.pageSizeDesc" }}'
                                                   title='{{ i18n "pages.settings.pageSize" }}' type="number" v-model="allSetting.pageSize"></setting-list-item>
                                <setting-list-item :min="0" desc='{{ i18n "pages.settings.expireTimeDiffDesc" }}'
                                                   title='{{ i18n "pages.settings.expireTimeDiff" }}'
                                                   type="number" v-model="allSetting.expireDiff"></setting-list-item>
                                <setting-list-item :min="0" desc='{{ i18n "pages.settings.trafficDiffDesc" }}'
                                                   title='{{ i18n "pages.settings.trafficDiff" }}'
                                                   type="number" v-model="allSetting.trafficDiff"></setting-list-item>
                                <setting-list-item :min="0" desc='{{ i18n "pages.settings.xrayCronJobDesc"}}'
                                                   title='{{ i18n "pages.settings.xrayCronJob"}}'
                                                   type="number" v-model="allSetting.xrayCronJob"></setting-list-item>
                                <setting-list-item :min="0" desc='{{ i18n "pages.settings.autoDeleteDayDesc"}}'
                                                   title='{{ i18n "pages.settings.autoDeleteDay"}}'
                                                   type="number" v-model="allSetting.autoDeleteDay"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.timeZoneDesc"}}' title='{{ i18n "pages.settings.timeZone"}}'
                                                   type="text"
                                                   v-model="allSetting.timeLocation"></setting-list-item>
                                <a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.settings.datepicker"}}'>
                                                <template slot="description">{{ i18n
                                                    "pages.settings.datepickerDescription"}}
                                                </template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select :dropdown-class-name="themeSwitcher.currentTheme"
                                                          style="width: 100%"
                                                          v-model="datepicker">
                                                    <a-select-option :value="item.value" v-for="item in datepickerList">
                                                        <span v-text="item.name"></span>
                                                    </a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                                <a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title="Language"></a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select :dropdown-class-name="themeSwitcher.currentTheme"
                                                          @change="setLang(lang)"
                                                          ref="selectLang"
                                                          style="width: 100%"
                                                          v-model="lang">
                                                    <a-select-option :label="l.value" :value="l.value"
                                                                     v-for="l in supportLangs">
                                                        <span :aria-label="l.name" role="img" v-text="l.icon"></span>
                                                        &nbsp;&nbsp; <span v-text="l.name"></span>
                                                    </a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                            </a-list>
                        </a-tab-pane>
                        <a-tab-pane key="2" style="padding: 20px;" tab='{{ i18n "pages.settings.securitySettings"}}'>
                            <a-divider>{{ i18n "pages.settings.security.admin"}}</a-divider>
                            <a-form :colon="false" :label-col="{ md: {span:10} }" :wrapper-col="{ md: {span:14} }"
                                    layout="horizontal" style="float: left; margin-bottom: 2rem;">
                                <a-form-item label='{{ i18n "pages.settings.oldUsername"}}'>
                                    <a-input autocomplete="username" v-model="user.oldUsername"></a-input>
                                </a-form-item>
                                <a-form-item label='{{ i18n "pages.settings.currentPassword"}}'>
                                    <password-input autocomplete="current-password"
                                                    v-model="user.oldPassword"></password-input>
                                </a-form-item>
                                <a-form-item label='{{ i18n "pages.settings.newUsername"}}'>
                                    <a-input v-model="user.newUsername"></a-input>
                                </a-form-item>
                                <a-form-item label='{{ i18n "pages.settings.newPassword"}}'>
                                    <password-input autocomplete="new-password"
                                                    v-model="user.newPassword"></password-input>
                                </a-form-item>
                                <a-form-item label=" ">
                                    <a-button @click="updateUser" type="primary">{{ i18n "confirm" }}</a-button>
                                </a-form-item>
                            </a-form>
                            <a-divider>{{ i18n "pages.settings.security.secret"}}</a-divider>
                            <a-form style="padding: 0 20px;">
                                <a-list-item>
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta description='{{ i18n "pages.settings.security.loginSecurityDesc" }}'
                                                              title='{{ i18n "pages.settings.security.loginSecurity" }}'>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-switch @change="toggleToken(allSetting.secretEnable)"
                                                          v-model="allSetting.secretEnable"></a-switch>
                                                <a-icon :spin="this.changeSecret" @click="getNewSecret"
                                                        style="margin-left: 1rem;" type="sync"
                                                        v-if="allSetting.secretEnable"></a-icon>
                                            </template>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                                <a-list-item>
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta description='{{ i18n "pages.settings.security.secretTokenDesc" }}'
                                                              title='{{ i18n "pages.settings.security.secretToken" }}'>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-textarea :disabled="!allSetting.secretEnable" type="text"
                                                            v-model="user.loginSecret"></a-textarea>
                                            </template>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                                <a-button :loading="this.changeSecret" @click="updateSecret" type="primary">{{ i18n
                                    "confirm" }}
                                </a-button>
                            </a-form>
                        </a-tab-pane>
                        <a-tab-pane key="3" tab='{{ i18n "pages.settings.TGBotSettings"}}'>
                            <a-list item-layout="horizontal">
                                <setting-list-item desc='{{ i18n "pages.settings.telegramBotEnableDesc" }}' title='{{ i18n "pages.settings.telegramBotEnable" }}'
                                                   type="switch"
                                                   v-model="allSetting.tgBotEnable"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.telegramTokenDesc"}}' title='{{ i18n "pages.settings.telegramToken"}}'
                                                   type="text"
                                                   v-model="allSetting.tgBotToken"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.telegramChatIdDesc"}}' title='{{ i18n "pages.settings.telegramChatId"}}'
                                                   type="text"
                                                   v-model="allSetting.tgBotChatId"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.telegramNotifyTimeDesc"}}' title='{{ i18n "pages.settings.telegramNotifyTime"}}'
                                                   type="text"
                                                   v-model="allSetting.tgRunTime"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.tgNotifyBackupDesc" }}' title='{{ i18n "pages.settings.tgNotifyBackup" }}'
                                                   type="switch"
                                                   v-model="allSetting.tgBotBackup"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.tgNotifyLoginDesc" }}' title='{{ i18n "pages.settings.tgNotifyLogin" }}'
                                                   type="switch"
                                                   v-model="allSetting.tgBotLoginNotify"></setting-list-item>
                                <setting-list-item :max="100" :min="0"
                                                   desc='{{ i18n "pages.settings.tgNotifyCpuDesc" }}'
                                                   title='{{ i18n "pages.settings.tgNotifyCpu" }}' type="number" v-model="allSetting.tgCpu"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.telegramProxyDesc"}}' placeholder="socks5://user:pass@host:port"
                                                   title='{{ i18n "pages.settings.telegramProxy"}}'
                                                   type="text"
                                                   v-model="allSetting.tgBotProxy"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.telegramAPIServerDesc"}}' placeholder="https://api.example.com"
                                                   title='{{ i18n "pages.settings.telegramAPIServer"}}'
                                                   type="text"
                                                   v-model="allSetting.tgBotAPIServer"></setting-list-item>
                                <a-list-item>
                                    <a-row style="padding: 20px">
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title="Telegram Bot Language"/>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <template>
                                                <a-select :dropdown-class-name="themeSwitcher.currentTheme" ref="selectBotLang"
                                                          style="width: 100%"
                                                          v-model="allSetting.tgLang">
                                                    <a-select-option :label="l.value" :value="l.value"
                                                                     v-for="l in supportLangs">
                                                        <span :aria-label="l.name" role="img" v-text="l.icon"></span>
                                                        &nbsp;&nbsp; <span v-text="l.name"></span>
                                                    </a-select-option>
                                                </a-select>
                                            </template>
                                        </a-col>
                                    </a-row>
                                </a-list-item>
                            </a-list>
                        </a-tab-pane>
                        <a-tab-pane key="4" tab='{{ i18n "pages.settings.subSettings" }}'>
                            <a-list item-layout="horizontal">
                                <setting-list-item desc='{{ i18n "pages.settings.subEnableDesc"}}' title='{{ i18n "pages.settings.subEnable"}}'
                                                   type="switch"
                                                   v-model="allSetting.subEnable"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subEncryptDesc"}}' title='{{ i18n "pages.settings.subEncrypt"}}'
                                                   type="switch"
                                                   v-model="allSetting.subEncrypt"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subUIDesc"}}' title='{{ i18n "pages.settings.subUI"}}'
                                                   type="switch"
                                                   v-model="allSetting.subCustomUI"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subShowInfoDesc"}}' title='{{ i18n "pages.settings.subShowInfo"}}'
                                                   type="switch"
                                                   v-model="allSetting.subShowInfo"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.clientSynchronizationDesc" }}'
                                                   title='{{ i18n "pages.settings.clientSynchronization" }}'
                                                   type="switch"
                                                   v-model="allSetting.syncClients"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subTitleDesc"}}' title='{{ i18n "pages.settings.subTitle"}}'
                                                   type="text"
                                                   v-model="allSetting.subTitle"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subSupportUrlDesc"}}' title='{{ i18n "pages.settings.subSupportUrl"}}'
                                                   type="text"
                                                   v-model="allSetting.subSupportUrl"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subProfileUrlDesc"}}' title='{{ i18n "pages.settings.subProfileUrl"}}'
                                                   type="text"
                                                   v-model="allSetting.subProfileUrl"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subAnnounceDesc"}}' title='{{ i18n "pages.settings.subAnnounce"}}'
                                                   type="text"
                                                   v-model="allSetting.subAnnounce"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subListenDesc"}}' title='{{ i18n "pages.settings.subListen"}}'
                                                   type="text"
                                                   v-model="allSetting.subListen"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subDomainDesc"}}' title='{{ i18n "pages.settings.subDomain"}}'
                                                   type="text"
                                                   v-model="allSetting.subDomain"></setting-list-item>
                                <setting-list-item :max="65531" :min="1"
                                                   desc='{{ i18n "pages.settings.subPortDesc"}}'
                                                   title='{{ i18n "pages.settings.subPort"}}' type="number"
                                                   v-model.number="allSetting.subPort"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subPathDesc"}}' title='{{ i18n "pages.settings.subPath"}}'
                                                   type="text"
                                                   v-model="allSetting.subPath"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subCertPathDesc"}}' title='{{ i18n "pages.settings.subCertPath"}}'
                                                   type="text"
                                                   v-model="allSetting.subCertFile"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subKeyPathDesc"}}' title='{{ i18n "pages.settings.subKeyPath"}}'
                                                   type="text"
                                                   v-model="allSetting.subKeyFile"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subURIDesc"}}' placeholder="(http|https)://domain[:port]/path/"
                                                   title='{{ i18n "pages.settings.subURI"}}'
                                                   type="text"
                                                   v-model="allSetting.subURI"></setting-list-item>
                                <setting-list-item :min="1" desc='{{ i18n "pages.settings.subUpdatesDesc"}}'
                                                   title='{{ i18n "pages.settings.subUpdates"}}'
                                                   type="number" v-model="allSetting.subUpdates"></setting-list-item>
                            </a-list>
                        </a-tab-pane>
                        <a-tab-pane key="5" tab='{{ i18n "pages.settings.subSettings" }} Json'
                                    v-if="allSetting.subEnable">
                            <a-list item-layout="horizontal">
                                <setting-list-item desc='{{ i18n "pages.settings.subPathDesc"}}' title='{{ i18n "pages.settings.subPath"}}'
                                                   type="text"
                                                   v-model="allSetting.subJsonPath"></setting-list-item>
                                <setting-list-item desc='{{ i18n "pages.settings.subURIDesc"}}' placeholder="(http|https)://domain[:port]/path/"
                                                   title='{{ i18n "pages.settings.subURI"}}'
                                                   type="text"
                                                   v-model="allSetting.subJsonURI"></setting-list-item>
                                <a-list-item style="padding: 20px">
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.settings.fragment"}}'>
                                                <template slot="description">{{ i18n "pages.settings.fragmentDesc"}}
                                                </template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-switch v-model="fragment"></a-switch>
                                        </a-col>
                                    </a-row>
                                    <a-collapse style="margin-top: 14px;" v-if="fragment">
                                        <a-collapse-panel header='{{ i18n "pages.settings.fragmentSett"}}'
                                                          v-if="fragment">
                                            <setting-list-item placeholder="1-1 | 1-3 | tlshello | ..." style="padding: 10px 20px" title='Packets'
                                                               type="text"
                                                               v-model="fragmentPackets"></setting-list-item>
                                            <setting-list-item placeholder="100-200" style="padding: 10px 20px" title='Length'
                                                               type="text"
                                                               v-model="fragmentLength"></setting-list-item>
                                            <setting-list-item placeholder="10-20" style="padding: 10px 20px" title='Interval'
                                                               type="text"
                                                               v-model="fragmentInterval"></setting-list-item>
                                            <setting-list-item placeholder="300-400" style="padding: 10px 20px" title='MaxSplit'
                                                               type="text"
                                                               v-model="fragmentMaxSplit"></setting-list-item>
                                        </a-collapse-panel>
                                    </a-collapse>
                                </a-list-item>
                                <a-list-item style="padding: 20px">
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='Noises'>
                                                <template slot="description">{{ i18n "pages.settings.noisesDesc"}}
                                                </template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-switch v-model="noises"></a-switch>
                                        </a-col>
                                    </a-row>
                                    <a-collapse style="margin-top: 14px;" v-if="noises">
                                        <a-collapse-panel :header="`Noise ${index + 1}`" :key="index"
                                                          v-for="(noise, index) in noisesArray">
                                            <a-list-item style="padding: 10px 20px">
                                                <a-row>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-list-item-meta title='Type'></a-list-item-meta>
                                                    </a-col>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-select :dropdown-class-name="themeSwitcher.currentTheme" :value="noise.type"
                                                                  @change="(value) => updateNoiseType(index, value)"
                                                                  style="width: 100%">
                                                            <a-select-option :key="p" :label="p"
                                                                             :value="p"
                                                                             v-for="p in ['rand', 'base64', 'str', 'hex']">
                                                                [[ p ]]
                                                            </a-select-option>
                                                        </a-select>
                                                    </a-col>
                                                </a-row>
                                            </a-list-item>
                                            <a-list-item style="padding: 10px 20px">
                                                <a-row>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-list-item-meta title='Apply To'></a-list-item-meta>
                                                    </a-col>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-select :dropdown-class-name="themeSwitcher.currentTheme" :value="noise.applyTo"
                                                                  @change="(value) => updateNoiseApplyTo(index, value)"
                                                                  style="width: 100%">
                                                            <a-select-option :key="p" :label="p"
                                                                             :value="p"
                                                                             v-for="p in ['ip', 'ipv4', 'ipv6']">
                                                                [[ p ]]
                                                            </a-select-option>
                                                        </a-select>
                                                    </a-col>
                                                </a-row>
                                            </a-list-item>
                                            <setting-list-item :value="noise.packet" @input="(value) => updateNoisePacket(index, value)" placeholder="5-10"
                                                               style="padding: 10px 20px"
                                                               title='Packet'
                                                               type="text"></setting-list-item>
                                            <setting-list-item :value="noise.delay" @input="(value) => updateNoiseDelay(index, value)" placeholder="10-20"
                                                               style="padding: 10px 20px"
                                                               title='Delay (ms)'
                                                               type="text"></setting-list-item>
                                            <a-button @click="removeNoise(index)" type="danger"
                                                      v-if="noisesArray.length > 1">Remove
                                            </a-button>
                                        </a-collapse-panel>
                                    </a-collapse>
                                    <a-button @click="addNoise" style="margin-top: 10px" type="primary" v-if="noises">
                                        Add Noise
                                    </a-button>
                                </a-list-item>
                                <a-list-item style="padding: 20px">
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.settings.mux"}}'>
                                                <template slot="description">{{ i18n "pages.settings.muxDesc"}}
                                                </template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-switch v-model="enableMux"></a-switch>
                                        </a-col>
                                    </a-row>
                                    <a-collapse style="margin-top: 14px;" v-if="enableMux">
                                        <a-collapse-panel header='{{ i18n "pages.settings.muxSett"}}'>
                                            <setting-list-item :max="1024" :min="-1"
                                                               style="padding: 10px 20px" title='Concurrency' type="number"
                                                               v-model="muxConcurrency"></setting-list-item>
                                            <setting-list-item :max="1024" :min="-1"
                                                               style="padding: 10px 20px" title='xudp Concurrency'
                                                               type="number" v-model="muxXudpConcurrency"></setting-list-item>
                                            <a-list-item style="padding: 10px 20px">
                                                <a-row>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-list-item-meta title='xudp UDP 443'></a-list-item-meta>
                                                    </a-col>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-select :dropdown-class-name="themeSwitcher.currentTheme" style="width: 100%"
                                                                  v-model="muxXudpProxyUDP443">
                                                            <a-select-option :label="p" :value="p"
                                                                             v-for="p in ['reject', 'allow', 'skip']">
                                                                [[ p ]]
                                                            </a-select-option>
                                                        </a-select>
                                                    </a-col>
                                                </a-row>
                                            </a-list-item>
                                        </a-collapse-panel>
                                    </a-collapse>
                                </a-list-item>
                                <a-list-item style="padding: 20px">
                                    <a-row>
                                        <a-col :lg="24" :xl="12">
                                            <a-list-item-meta title='{{ i18n "pages.settings.direct"}}'>
                                                <template slot="description">{{ i18n "pages.settings.directDesc"}}
                                                </template>
                                            </a-list-item-meta>
                                        </a-col>
                                        <a-col :lg="24" :xl="12">
                                            <a-switch v-model="enableDirect"></a-switch>
                                        </a-col>
                                    </a-row>
                                    <a-collapse style="margin-top: 14px;" v-if="enableDirect">
                                        <a-collapse-panel header='{{ i18n "pages.settings.direct"}}'>
                                            <a-list-item>
                                                <a-row style="padding: 0 20px">
                                                    <a-col :lg="24" :xl="12">
                                                        <a-list-item-meta
                                                                title='{{ i18n "pages.xray.directips" }}'/>
                                                    </a-col>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-select :dropdown-class-name="themeSwitcher.currentTheme" mode="tags"
                                                                  style="width: 100%"
                                                                  v-model="directIPs">
                                                            <a-select-option :label="p.label" :value="p.value"
                                                                             v-for="p in directIPsOptions"> [[ p.label
                                                                ]]
                                                            </a-select-option>
                                                        </a-select>
                                                    </a-col>
                                                </a-row>
                                            </a-list-item>
                                            <a-list-item>
                                                <a-row style="padding: 0 20px">
                                                    <a-col :lg="24" :xl="12">
                                                        <a-list-item-meta
                                                                title='{{ i18n "pages.xray.directdomains" }}'/>
                                                    </a-col>
                                                    <a-col :lg="24" :xl="12">
                                                        <a-select :dropdown-class-name="themeSwitcher.currentTheme" mode="tags"
                                                                  style="width: 100%"
                                                                  v-model="directDomains">
                                                            <a-select-option :label="p.label" :value="p.value"
                                                                             v-for="p in diretDomainsOptions"> [[
                                                                p.label ]]
                                                            </a-select-option>
                                                        </a-select>
                                                    </a-col>
                                                </a-row>
                                            </a-list-item>
                                        </a-collapse-panel>
                                    </a-collapse>
                                </a-list-item>
                            </a-list>
                        </a-tab-pane>
                    </a-tabs>
                </a-space>
            </a-spin>
        </a-layout-content>
    </a-layout>
</a-layout>
{{template "js" .}}
<script src="{{ .base_path }}assets/js/model/setting.js?{{ .cur_ver }}"></script>
{{template "component/themeSwitcher" .}}
{{template "component/password" .}}
{{template "component/setting"}}
<script>
    const app = new Vue({
        delimiters: ['[[', ']]'],
        el: '#app',
        data: {
            siderDrawer,
            themeSwitcher,
            spinning: false,
            changeSecret: false,
            oldAllSetting: new AllSetting(),
            allSetting: new AllSetting(),
            saveBtnDisable: true,
            user: {},
            lang: getLang(),
            remarkModels: {i: 'Inbound', e: 'Email', o: 'Other'},
            remarkSeparators: [' ', '-', '_', '@', ':', '~', '|', ',', '.', '/'],
            datepickerList: [{name: 'Gregorian (Standard)', value: 'gregorian'}, {
                name: 'Jalalian (Ø´Ù…Ø³ÛŒ)',
                value: 'jalalian'
            }],
            remarkSample: '',
            defaultFragment: {
                tag: "fragment",
                protocol: "freedom",
                settings: {
                    domainStrategy: "AsIs",
                    fragment: {
                        packets: "tlshello",
                        length: "100-200",
                        interval: "10-20",
                        maxSplit: "300-400"
                    }
                },
                streamSettings: {
                    sockopt: {
                        tcpKeepAliveIdle: 100,
                        tcpMptcp: true,
                        penetrate: true
                    }
                }
            },
            defaultNoises: {
                tag: "noises",
                protocol: "freedom",
                settings: {
                    domainStrategy: "AsIs",
                    noises: [
                        {type: "rand", packet: "10-20", delay: "10-16", applyTo: "ip"},
                    ],
                },
            },
            defaultMux: {
                enabled: true,
                concurrency: 8,
                xudpConcurrency: 16,
                xudpProxyUDP443: "reject"
            },
            defaultRules: [
                {
                    type: "field",
                    outboundTag: "direct",
                    domain: [
                        "geosite:category-ir"
                    ]
                },
                {
                    type: "field",
                    outboundTag: "direct",
                    ip: [
                        "geoip:private",
                        "geoip:ir"
                    ]
                },
            ],
            directIPsOptions: [
                {label: 'Private IP', value: 'geoip:private'},
                {label: 'ðŸ‡®ðŸ‡· Iran', value: 'geoip:ir'},
                {label: 'ðŸ‡¨ðŸ‡³ China', value: 'geoip:cn'},
                {label: 'ðŸ‡·ðŸ‡º Russia', value: 'geoip:ru'},
                {label: 'ðŸ‡»ðŸ‡³ Vietnam', value: 'geoip:vn'},
                {label: 'ðŸ‡ªðŸ‡¸ Spain', value: 'geoip:es'},
                {label: 'ðŸ‡®ðŸ‡© Indonesia', value: 'geoip:id'},
                {label: 'ðŸ‡ºðŸ‡¦ Ukraine', value: 'geoip:ua'},
                {label: 'ðŸ‡¹ðŸ‡· TÃ¼rkiye', value: 'geoip:tr'},
                {label: 'ðŸ‡§ðŸ‡· Brazil', value: 'geoip:br'},
            ],
            diretDomainsOptions: [
                {label: 'Private DNS', value: 'geosite:private'},
                {label: 'ðŸ‡®ðŸ‡· Iran', value: 'geosite:category-ir'},
                {label: 'ðŸ‡¨ðŸ‡³ China', value: 'geosite:cn'},
                {label: 'ðŸ‡·ðŸ‡º Russia', value: 'geosite:category-ru'},
                {label: 'Apple', value: 'geosite:apple'},
                {label: 'Meta', value: 'geosite:meta'},
                {label: 'Google', value: 'geosite:google'},
            ],
            get remarkModel() {
                rm = this.allSetting.remarkModel;
                return rm.length > 1 ? rm.substring(1).split('') : [];
            },
            set remarkModel(value) {
                rs = this.allSetting.remarkModel[0];
                this.allSetting.remarkModel = rs + value.join('');
                this.changeRemarkSample();
            },
            get remarkSeparator() {
                return this.allSetting.remarkModel.length > 1 ? this.allSetting.remarkModel.charAt(0) : '-';
            },
            set remarkSeparator(value) {
                this.allSetting.remarkModel = value + this.allSetting.remarkModel.substring(1);
                this.changeRemarkSample();
            },
            get datepicker() {
                return this.allSetting.datepicker ? this.allSetting.datepicker : 'gregorian';
            },
            set datepicker(value) {
                this.allSetting.datepicker = value;
            },
            changeRemarkSample() {
                sample = []
                this.remarkModel.forEach(r => sample.push(this.remarkModels[r]));
                this.remarkSample = sample.length == 0 ? '' : sample.join(this.remarkSeparator);
            }
        },
        methods: {
            loading(spinning = true) {
                this.spinning = spinning;
            },
            async getAllSetting() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/all");
                this.loading(false);
                if (msg.success) {
                    this.oldAllSetting = new AllSetting(msg.obj);
                    this.allSetting = new AllSetting(msg.obj);
                    app.changeRemarkSample();
                    this.saveBtnDisable = true;
                }
                await this.fetchUserSecret();
            },
            async updateAllSetting() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/update", this.allSetting);
                this.loading(false);
                if (msg.success) {
                    await this.getAllSetting();
                }
            },
            async updateUser() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/updateUser", this.user);
                this.loading(false);
                if (msg.success) {
                    this.user = {};
                    window.location.replace(basePath + "logout");
                }
            },
            async restartPanel() {
                await new Promise(resolve => {
                    this.$confirm({
                        title: '{{ i18n "pages.settings.restartPanel" }}',
                        content: '{{ i18n "pages.settings.restartPanelDesc" }}',
                        class: themeSwitcher.currentTheme,
                        okText: '{{ i18n "sure" }}',
                        cancelText: '{{ i18n "cancel" }}',
                        onOk: () => resolve(),
                    });
                });
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/restartPanel");
                this.loading(false);
                if (msg.success) {
                    this.loading(true);
                    await PromiseUtil.sleep(5000);
                    var {webCertFile, webKeyFile, webDomain: host, webPort: port, webBasePath: base} = this.allSetting;
                    if (host == this.oldAllSetting.webDomain) host = null;
                    if (port == this.oldAllSetting.webPort) port = null;
                    const isTLS = webCertFile !== "" || webKeyFile !== "";
                    const url = buildURL({host, port, isTLS, base, path: "panel/settings"});
                    window.location.replace(url);
                }
            },
            async fetchUserSecret() {
                this.loading(true);
                const userMessage = await HttpUtil.post("/panel/setting/getUserSecret", this.user);
                if (userMessage.success) {
                    this.user = userMessage.obj;
                }
                this.loading(false);
            },
            async updateSecret() {
                this.loading(true);
                const msg = await HttpUtil.post("/panel/setting/updateUserSecret", this.user);
                if (msg && msg.obj) {
                    this.user = msg.obj;
                }
                this.loading(false);
                await this.updateAllSetting();
            },
            generateRandomString(length) {
                var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
                let randomString = "";
                for (let i = 0; i < length; i++) {
                    randomString += chars[Math.floor(Math.random() * chars.length)];
                }
                return randomString;
            },
            async getNewSecret() {
                if (!this.changeSecret) {
                    this.changeSecret = true;
                    this.user.loginSecret = '';
                    const newSecret = this.generateRandomString(64);
                    await PromiseUtil.sleep(1000);
                    this.user.loginSecret = newSecret;
                    this.changeSecret = false;
                }
            },
            async toggleToken(value) {
                if (value) {
                    await this.getNewSecret();
                } else {
                    this.user.loginSecret = "";
                }
            },
            addNoise() {
                const newNoise = {type: "rand", packet: "10-20", delay: "10-16", applyTo: "ip"};
                this.noisesArray = [...this.noisesArray, newNoise];
            },
            removeNoise(index) {
                const newNoises = [...this.noisesArray];
                newNoises.splice(index, 1);
                this.noisesArray = newNoises;
            },
            updateNoiseApplyTo(index, value) {
                const updatedNoises = [...this.noisesArray];
                updatedNoises[index] = {...updatedNoises[index], applyTo: value};
                this.noisesArray = updatedNoises;
            },
            updateNoiseType(index, value) {
                const updatedNoises = [...this.noisesArray];
                updatedNoises[index] = {...updatedNoises[index], type: value};
                this.noisesArray = updatedNoises;
            },
            updateNoisePacket(index, value) {
                const updatedNoises = [...this.noisesArray];
                updatedNoises[index] = {...updatedNoises[index], packet: value};
                this.noisesArray = updatedNoises;
            },
            updateNoiseDelay(index, value) {
                const updatedNoises = [...this.noisesArray];
                updatedNoises[index] = {...updatedNoises[index], delay: value};
                this.noisesArray = updatedNoises;
            },
        },
        computed: {
            fragment: {
                get: function () {
                    return this.allSetting?.subJsonFragment != "";
                },
                set: function (v) {
                    this.allSetting.subJsonFragment = v ? JSON.stringify(this.defaultFragment) : "";
                }
            },
            fragmentPackets: {
                get: function () {
                    return this.fragment ? JSON.parse(this.allSetting.subJsonFragment).settings.fragment.packets : "";
                },
                set: function (v) {
                    if (v != "") {
                        newFragment = JSON.parse(this.allSetting.subJsonFragment);
                        newFragment.settings.fragment.packets = v;
                        this.allSetting.subJsonFragment = JSON.stringify(newFragment);
                    }
                }
            },
            fragmentLength: {
                get: function () {
                    return this.fragment ? JSON.parse(this.allSetting.subJsonFragment).settings.fragment.length : "";
                },
                set: function (v) {
                    if (v != "") {
                        newFragment = JSON.parse(this.allSetting.subJsonFragment);
                        newFragment.settings.fragment.length = v;
                        this.allSetting.subJsonFragment = JSON.stringify(newFragment);
                    }
                }
            },
            fragmentInterval: {
                get: function () {
                    return this.fragment ? JSON.parse(this.allSetting.subJsonFragment).settings.fragment.interval : "";
                },
                set: function (v) {
                    if (v != "") {
                        newFragment = JSON.parse(this.allSetting.subJsonFragment);
                        newFragment.settings.fragment.interval = v;
                        this.allSetting.subJsonFragment = JSON.stringify(newFragment);
                    }
                }
            },
            fragmentMaxSplit: {
                get: function () {
                    return this.fragment ? JSON.parse(this.allSetting.subJsonFragment).settings.fragment.maxSplit : "";
                },
                set: function (v) {
                    if (v != "") {
                        newFragment = JSON.parse(this.allSetting.subJsonFragment);
                        newFragment.settings.fragment.maxSplit = v;
                        this.allSetting.subJsonFragment = JSON.stringify(newFragment);
                    }
                }
            },
            noises: {
                get() {
                    return this.allSetting?.subJsonNoises != "";
                },
                set(v) {
                    if (v) {
                        this.allSetting.subJsonNoises = JSON.stringify(this.defaultNoises);
                    } else {
                        this.allSetting.subJsonNoises = "";
                    }
                }
            },
            noisesArray: {
                get() {
                    return this.noises ? JSON.parse(this.allSetting.subJsonNoises).settings.noises : [];
                },
                set(value) {
                    if (this.noises) {
                        const newNoises = JSON.parse(this.allSetting.subJsonNoises);
                        newNoises.settings.noises = value;
                        this.allSetting.subJsonNoises = JSON.stringify(newNoises);
                    }
                }
            },
            enableMux: {
                get: function () {
                    return this.allSetting?.subJsonMux != "";
                },
                set: function (v) {
                    this.allSetting.subJsonMux = v ? JSON.stringify(this.defaultMux) : "";
                }
            },
            muxConcurrency: {
                get: function () {
                    return this.enableMux ? JSON.parse(this.allSetting.subJsonMux).concurrency : -1;
                },
                set: function (v) {
                    newMux = JSON.parse(this.allSetting.subJsonMux);
                    newMux.concurrency = v;
                    this.allSetting.subJsonMux = JSON.stringify(newMux);
                }
            },
            muxXudpConcurrency: {
                get: function () {
                    return this.enableMux ? JSON.parse(this.allSetting.subJsonMux).xudpConcurrency : -1;
                },
                set: function (v) {
                    newMux = JSON.parse(this.allSetting.subJsonMux);
                    newMux.xudpConcurrency = v;
                    this.allSetting.subJsonMux = JSON.stringify(newMux);
                }
            },
            muxXudpProxyUDP443: {
                get: function () {
                    return this.enableMux ? JSON.parse(this.allSetting.subJsonMux).xudpProxyUDP443 : "reject";
                },
                set: function (v) {
                    newMux = JSON.parse(this.allSetting.subJsonMux);
                    newMux.xudpProxyUDP443 = v;
                    this.allSetting.subJsonMux = JSON.stringify(newMux);
                }
            },
            enableDirect: {
                get: function () {
                    return this.allSetting?.subJsonRules != "";
                },
                set: function (v) {
                    this.allSetting.subJsonRules = v ? JSON.stringify(this.defaultRules) : "";
                }
            },
            directIPs: {
                get: function () {
                    if (!this.enableDirect) return [];
                    const rules = JSON.parse(this.allSetting.subJsonRules);
                    if (!Array.isArray(rules)) return [];
                    const ipRule = rules.find(r => r.ip);
                    return ipRule?.ip ?? [];
                },
                set: function (v) {
                    let rules = JSON.parse(this.allSetting.subJsonRules);
                    if (!Array.isArray(rules)) return;

                    if (v.length == 0) {
                        rules = rules.filter(r => !r.ip);
                    } else {
                        let ruleIndex = rules.findIndex(r => r.ip);
                        if (ruleIndex == -1) ruleIndex = rules.push(this.defaultRules[1]) - 1;

                        rules[ruleIndex].ip = [];
                        v.forEach(d => {
                            rules[ruleIndex].ip.push(d);
                        });
                    }
                    this.allSetting.subJsonRules = JSON.stringify(rules);
                }
            },
            directDomains: {
                get: function () {
                    if (!this.enableDirect) return [];
                    const rules = JSON.parse(this.allSetting.subJsonRules);
                    if (!Array.isArray(rules)) return [];
                    const domainRule = rules.find(r => r.domain);
                    return domainRule?.domain ?? [];
                },
                set: function (v) {
                    let rules = JSON.parse(this.allSetting.subJsonRules);
                    if (!Array.isArray(rules)) return;
                    if (v.length == 0) {
                        rules = rules.filter(r => !r.domain);
                    } else {
                        let ruleIndex = rules.findIndex(r => r.domain);
                        if (ruleIndex == -1) ruleIndex = rules.push(this.defaultRules[0]) - 1;

                        rules[ruleIndex].domain = v;
                    }
                    this.allSetting.subJsonRules = JSON.stringify(rules);
                }
            },
            confAlerts: {
                get: function () {
                    if (!this.allSetting) return [];
                    var alerts = [];
                    if (window.location.protocol !== "https:") alerts.push('{{ i18n "secAlertSSL" }}');
                    if (this.allSetting.webPort == 2053) alerts.push('{{ i18n "secAlertPanelPort" }}');
                    panelPath = window.location.pathname.split('/').length < 4;
                    if (panelPath && this.allSetting.webBasePath == '/') alerts.push('{{ i18n "secAlertPanelURI" }}');
                    if (this.allSetting.subEnable) {
                        try {
                            subPath = this.allSetting.subURI.length > 0 ? new URL(this.allSetting.subURI).pathname : this.allSetting.subPath;
                            if (subPath == '/sub/') alerts.push('{{ i18n "secAlertSubURI" }}');
                        } catch (e) {
                            alerts.push(e);
                        }
                        try {
                            subJsonPath = this.allSetting.subJsonURI.length > 0 ? new URL(this.allSetting.subJsonURI).pathname : this.allSetting.subJsonPath;
                            if (subJsonPath == '/json/') alerts.push('{{ i18n "secAlertSubJsonURI" }}');
                        } catch (e) {
                            alerts.push(e);
                        }
                    }
                    return alerts;
                }
            }
        },
        async mounted() {
            await this.getAllSetting();
            while (true) {
                await PromiseUtil.sleep(1000);
                this.saveBtnDisable = this.oldAllSetting.equals(this.allSetting);
            }
        }
    });
</script>
</body>
</html>